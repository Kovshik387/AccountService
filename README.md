# Account Service – REST API для сервиса банковских счетов

## Запуск

**1. Клонирование репозитория**
    ```git clone git@github.com:Kovshik387/AccountService.git```

**2. Запуск через Docker Compose**
    В корне проекта для запуска необходим установленный docker-comopose. В корне необходимо выполнить ```docker compose up```
**3. Доступ к сервису**
    После чего будет доступна страница swagger по адрессу `https://localhost:80/swagger/index.html`

## Реализованные функции сервиса

- Создание счёта
- Изменение счёта
- Удаление счёта
- Получение списка счетов
- Регистрация транзакции по счёту
- Перевод между счетами
- Получение выписки клиента
- Проверка наличия счёта у клиента

## Swagger

Все методы, параметры и возвращаемые значения задокументированы на странице `https://localhost:80/swagger/index.html`

## Вторая неделя

- Были добавлены описания возвращаемых типов в swagger
- Добавлена обёртка для возвращаемых значений `MbResult`, в котором находится поле `MbError`, которое включает словарь ошибок
- Все методы API защищены авторизацией через JWT access token.
- Был развёрнут keycloak в docker'е, для получения accessToken'а необходимо выполнить [запрос](/GetAccessTokenTest.http)
- Поддержка CORS: AllowAll активирована - можно обращаться с любого источника

## Третья неделя

- Все методы требуют валидного JWT; без токена — 401
- Тесты `dotnet test` проходят в чистом окружении
- Ежедневный Hangfire Cron‑Job начисляет проценты
- При конкурентном изменении одного счёта второй запрос получает 409 Conflict
- Созданы индексы для ускорения частых запросов

## Четвёртая неделя
- Подключён **RabbitMQ** [конфиг](/config/rabbitMq/definitions.json)
- RabbitMQ доступен на стандартном порту `15672`, UI — на `http://localhost:15672` (логин/пароль: `user`/`user`)
- Реализован шаблон **Transactional Outbox** для всех командных хендлеров
- Добавлен **AntifraudConsumer**, который обрабатывает события `ClientBlocked` и `ClientUnblocked`
- События документированы и доступны
- В логах теперь фиксируются `eventId`, `correlationId`, `retry`, `latency` для публикации и потребления событий
- Использована библиотека **Polly** для повторных публикаций с экспоненциальной паузой и джиттером
- Реализован карантин входящих сообщений (`inbox_dead_letters`) при ошибке envelope/версии
- Интеграционные тесты:
    - `OutboxPublishesAfterFailure` (повторная публикация после недоступности RabbitMQ)
    - `ClientBlockedPreventsDebit` (запрет расходных операций при блокировке клиента)